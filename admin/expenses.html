<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expenses - Temple Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <script>
    if (localStorage.getItem("isLoggedIn") !== "true") {
      window.location.href = "../login.html";
    }
  </script>

  <header class="bg-blue-700 text-white p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Expenses</h1>
    <a href="dashboard.html" class="text-white underline hover:text-gray-300">Back to Dashboard</a>
  </header>

  <main class="container mx-auto p-6">
    <section class="bg-white p-6 rounded shadow max-w-xl mx-auto">
      <h2 class="text-xl font-semibold mb-4" id="formTitle">Add New Expense</h2>
      <form id="expenseForm" class="space-y-4">
        <input type="hidden" id="editIndex" value="-1" />
        <div>
          <label for="expenseTitle" class="block font-medium mb-1">Title</label>
          <input type="text" id="expenseTitle" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="expenseAmount" class="block font-medium mb-1">Amount (₹)</label>
          <input type="number" id="expenseAmount" min="1" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="expenseDate" class="block font-medium mb-1">Date</label>
          <input type="date" id="expenseDate" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="expenseNotes" class="block font-medium mb-1">Notes (optional)</label>
          <textarea id="expenseNotes" class="w-full border border-gray-300 rounded px-3 py-2" rows="2"></textarea>
        </div>

        <div>
          <label for="receiptImage" class="block font-medium mb-1">Upload Image (optional)</label>
          <input type="file" id="receiptImage" name="receiptImage" accept="image/*" />
        </div>

        <button type="submit" class="bg-blue-700 text-white py-2 rounded w-full hover:bg-blue-800 transition" id="submitBtn">
          Add Expense
        </button>
        <button type="button" id="cancelEditBtn" class="hidden bg-gray-500 text-white py-2 rounded w-full hover:bg-gray-600 transition mt-2">Cancel Edit</button>
      </form>
    </section>

    <section class="mt-10 max-w-3xl mx-auto">
      <h2 class="text-xl font-semibold mb-4">Expenses List</h2>
      <table class="min-w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-blue-700 text-white text-left">
            <th class="px-4 py-2">Title</th>
            <th class="px-4 py-2">Amount (₹)</th>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Notes</th>
            <th class="px-4 py-2">Image</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="expensesTableBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // Redirect to login if not logged in
    if (localStorage.getItem("isLoggedIn") !== "true") {
      window.location.href = "../login.html";
    }

    const expenseForm = document.getElementById("expenseForm");
    const expensesTableBody = document.getElementById("expensesTableBody");
    const formTitle = document.getElementById("formTitle");
    const submitBtn = document.getElementById("submitBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const editIndexInput = document.getElementById("editIndex");

    let expenses = JSON.parse(localStorage.getItem("expenses")) || [];

    function renderExpenses() {
      expensesTableBody.innerHTML = "";
      expenses.forEach((expense, index) => {
        const tr = document.createElement("tr");
        tr.classList.add("border-b");
        tr.innerHTML = `
          <td class="px-4 py-2">${expense.title}</td>
          <td class="px-4 py-2">₹${expense.amount}</td>
          <td class="px-4 py-2">${expense.date}</td>
          <td class="px-4 py-2">${expense.notes || ""}</td>
          <td class="px-4 py-2">
            ${expense.image ? `<img src="${expense.image}" alt="Receipt" class="w-20 h-auto rounded">` : "No Image"}
          </td>
          <td class="px-4 py-2 space-x-2">
            <button data-index="${index}" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 editBtn">Edit</button>
            <button data-index="${index}" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 deleteBtn">Delete</button>
          </td>
        `;
        expensesTableBody.appendChild(tr);
      });

      // Attach edit event listeners
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", e => {
          const idx = e.target.getAttribute("data-index");
          startEditExpense(idx);
        });
      });

      // Attach delete event listeners
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", e => {
          const idx = e.target.getAttribute("data-index");
          if (confirm("Are you sure you want to delete this expense?")) {
            expenses.splice(idx, 1);
            saveAndRender();
          }
        });
      });
    }

    function saveAndRender() {
      localStorage.setItem("expenses", JSON.stringify(expenses));
      renderExpenses();
      resetForm();
    }

    function resetForm() {
      expenseForm.reset();
      editIndexInput.value = -1;
      formTitle.textContent = "Add New Expense";
      submitBtn.textContent = "Add Expense";
      cancelEditBtn.classList.add("hidden");
    }

    function startEditExpense(index) {
      const expense = expenses[index];
      expenseForm.expenseTitle.value = expense.title;
      expenseForm.expenseAmount.value = expense.amount;
      expenseForm.expenseDate.value = expense.date;
      expenseForm.expenseNotes.value = expense.notes;
      editIndexInput.value = index;
      formTitle.textContent = "Edit Expense";
      submitBtn.textContent = "Save Changes";
      cancelEditBtn.classList.remove("hidden");
    }

    cancelEditBtn.addEventListener("click", () => {
      resetForm();
    });

    expenseForm.addEventListener("submit", e => {
      e.preventDefault();

      const file = document.getElementById("receiptImage").files[0];
      const reader = new FileReader();

      reader.onloadend = () => {
        const newExpense = {
          title: expenseForm.expenseTitle.value.trim(),
          amount: parseFloat(expenseForm.expenseAmount.value),
          date: expenseForm.expenseDate.value,
          notes: expenseForm.expenseNotes.value.trim(),
          image: reader.result || ""
        };

        const editIndex = parseInt(editIndexInput.value);
        if (editIndex === -1) {
          expenses.push(newExpense);
        } else {
          expenses[editIndex] = newExpense;
        }

        saveAndRender();
      };

      if (file) {
        reader.readAsDataURL(file);
      } else {
        // No image selected, proceed with empty string
        reader.onloadend();
      }
    });

    renderExpenses();
  </script>
</body>
</html>
